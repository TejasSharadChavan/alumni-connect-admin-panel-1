<!doctype html>
<html>
  <head>
    <title>Debug Payment Flow</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .result {
        background: #f5f5f5;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .error {
        background: #ffe6e6;
        border: 1px solid #ff9999;
      }
      .success {
        background: #e6ffe6;
        border: 1px solid #99ff99;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
      input,
      select {
        padding: 8px;
        margin: 5px;
        width: 200px;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .form-group {
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Debug Payment Flow</h1>

      <div class="form-group">
        <label>Email:</label>
        <input type="email" id="email" value="rahul.agarwal@gmail.com" />
      </div>

      <div class="form-group">
        <label>Password:</label>
        <input type="password" id="password" value="Password@123" />
      </div>

      <div class="form-group">
        <label>Amount:</label>
        <input type="number" id="amount" value="1000" min="100" />
      </div>

      <div class="form-group">
        <label>Message:</label>
        <input type="text" id="message" value="Test donation from debug" />
      </div>

      <div>
        <button onclick="testLogin()">1. Login</button>
        <button onclick="testAuthMe()">2. Test Auth Me</button>
        <button onclick="testCreateOrder()">3. Create Order</button>
        <button onclick="testFullFlow()">4. Full Flow</button>
        <button onclick="clearResults()">Clear</button>
      </div>

      <div id="results"></div>
    </div>

    <script>
      let authToken = null;

      function addResult(title, content, isError = false) {
        const results = document.getElementById("results");
        const div = document.createElement("div");
        div.className = `result ${isError ? "error" : "success"}`;
        div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
        results.appendChild(div);
      }

      function clearResults() {
        document.getElementById("results").innerHTML = "";
      }

      async function testLogin() {
        try {
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();
          if (data.success) {
            authToken = data.token;
            addResult(
              "Login Test",
              `✅ Success! Token: ${authToken.substring(0, 30)}...`
            );
          } else {
            addResult(
              "Login Test",
              `❌ Failed: ${JSON.stringify(data, null, 2)}`,
              true
            );
          }
        } catch (error) {
          addResult("Login Test", `❌ Error: ${error.message}`, true);
        }
      }

      async function testAuthMe() {
        if (!authToken) {
          addResult("Auth Me Test", "❌ Please login first", true);
          return;
        }

        try {
          const response = await fetch("/api/auth/me", {
            headers: { Authorization: `Bearer ${authToken}` },
          });

          const data = await response.json();
          if (response.ok) {
            addResult(
              "Auth Me Test",
              `✅ User: ${data.user.name} (${data.user.email})`
            );
          } else {
            addResult(
              "Auth Me Test",
              `❌ Failed: ${JSON.stringify(data, null, 2)}`,
              true
            );
          }
        } catch (error) {
          addResult("Auth Me Test", `❌ Error: ${error.message}`, true);
        }
      }

      async function testCreateOrder() {
        if (!authToken) {
          addResult("Create Order Test", "❌ Please login first", true);
          return;
        }

        try {
          const amount = parseInt(document.getElementById("amount").value);
          const message = document.getElementById("message").value;

          const response = await fetch("/api/payments/razorpay/create-order", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ amount, message }),
          });

          const data = await response.json();
          if (response.ok) {
            addResult(
              "Create Order Test",
              `✅ Order Created:
Order ID: ${data.order.id}
Amount: ₹${data.order.amount / 100}
Donation ID: ${data.donationId}
Key: ${data.key}`
            );
          } else {
            addResult(
              "Create Order Test",
              `❌ Failed: ${JSON.stringify(data, null, 2)}`,
              true
            );
          }
        } catch (error) {
          addResult("Create Order Test", `❌ Error: ${error.message}`, true);
        }
      }

      async function testFullFlow() {
        clearResults();
        await testLogin();
        await new Promise((resolve) => setTimeout(resolve, 500));
        await testAuthMe();
        await new Promise((resolve) => setTimeout(resolve, 500));
        await testCreateOrder();
      }
    </script>
  </body>
</html>
